var cartitems = [];
//getCartItems(1);
//console.log("Cart Items: " + getCartItems(1)); //Undefined
var search_num = 1;
//QR80F7B958, 1d823b9dfa4c91eacf6add8b74cf5850, 8971c005b33dd38312267f2b6fd25ddb
// dev ('GXQGFDJRZL', 'eebe954ae7915374732dcd72e92b05de')
// var client = algoliasearch('JW24P65VGM', '33476d9bcb613498be950c6fbf1c3666');
//QR80F7B958', '8971c005b33dd38312267f2b6fd25ddb');
// var index = client.initIndex('magento_default_products'); //am_shop_products_tmp');
//console.log('yes');
//console.log(index);
var checkedvalues = [];
var checkedfacets = [];
var facetfilter = "";
var facets = ["cs_type", "filter_colour", "finish", "filter_material", "filter_size", "custom_thickness",
    "special_features", "visualiser_enabled"
];

var visualizer;


jQuery(document).ready(function () {

    jQuery.urlParam = function (name) { //check url parameters
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results != null)
           
            return results[1] || 0;
        else
            return 0;
    }

    if (jQuery.urlParam('sku') != 0) { //if sku in url then hide select a tile popup
        jQuery(".v-tiles-popup").addClass("hide");
        jQuery(".v-page-container img").on('load', function () { //when canvas img loaded
            jQuery(".v-left-button-group,.v-top-button-group").addClass("show");
        });

    }

    jQuery(".v-icon-button.v-tiles-button,.v-icon-button.v-single-tile-button").click(function () { //on tiles and single btn click
        jQuery(".v-tiles-popup").removeClass("hide").addClass("show");
    });

    jQuery(".v-tiles-popup-close-icon").click(function () {
        jQuery(".v-tiles-popup").removeClass("show");
    });

    var facetsarray = [];

    tilesearch(" ", [], 1);


    jQuery("#v-tiles-popup-id").click(function (e) {

        if (e.target === this) {
            jQuery(".v-tiles-popup-close-icon").click();
        }
    });

    jQuery("#v-pattern-popup-id").click(function (e) {
        if (e.target === this) {
            jQuery(".v-tiles-popup-close-icon").click();
        }
    });

    jQuery("#v-grout-popup-id").click(function (e) {
        if (e.target === this) {
            jQuery(".v-tiles-popup-close-icon").click();
        }
    });

    jQuery("#v-paint-popup-id").click(function (e) {
        if (e.target === this) {
            jQuery(".v-tiles-popup-close-icon").click();
        }
    });
    jQuery("#v-room-popup-id").click(function (e) {
        if (e.target === this) {
            jQuery(".v-tiles-popup-close-icon").click();
        }
    });


    visualizer = new TilesVisualiser();

});


function getFacetFilters() {
    var facetsarray = [];

    jQuery(".facetparent").each(function () {
        var temparray = [];
        jQuery(this).find(".facetcheckbox").each(function () {
            if (jQuery(this).is(':checked')) {
                jQuery(this).parent().parent().addClass('filter_selected');
                temparray.push(jQuery(this).data('facet') + ":" + jQuery(this).val());
                checkedvalues.push(jQuery(this).val());
                checkedfacets.push(jQuery(this).data('facet'));
            } else {
                checkedvalues.splice(jQuery.inArray(jQuery(this).val(), checkedvalues), 1);
                checkedfacets.splice(jQuery.inArray(jQuery(this).data('facet'), checkedfacets),
                    1);
            }
        });
        facetsarray.push(temparray);
    });

    return facetsarray;
}

function startSearchbyfacet(e) {
    if (jQuery(e).is(':checked')) {
        facetfilter = jQuery(e).data('facet');
    }


    tilesearch(index, jQuery("#tile-search_input").val(), getFacetFilters(), 0);
}


function startSearch(e) {
    tilesearch(index, e.value, getFacetFilters(), 0);
}


var getUrlParameter = function getUrlParameter(sParam) {

    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;


    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
        }
    }
};


function tilesearch(query, facetsarray, domint) {
    // var content = (function () {
    //     var json = null;
    //     $.ajax({
    //         'async': false,
    //         'global': false,
    //         'url': "../products.json",
    //         'dataType': "json",
    //         'success': function (data) {
    //             json = data;
    //         }
    //     });
    //     return json;
    // })();

    var temparray = [];
    temparray.push("visualiser_enabled:Yes");
    facetsarray.push(temparray);
    //jQuery(".v-message.v-hide").show();

    //jQuery(".v-message.v-hide").hide();
    // var query_term = content.query;
    var query_term = "%20&attributesToRetrieve=%5B%22sku%22%2C%22size%22%2C%22name%22%2C%22categories%22%2C%22cs_sample_price%22%2C%22samples_allowed%22%2C%22cs_type%22%5D&hitsPerPage=2000&facetFilters=%5B%5B%22visualiser_enabled%3AYes%22%5D%5D&facets=%5B%22cs_type%22%2C%22filter_colour%22%2C%22finish%22%2C%22filter_material%22%2C%22filter_size%22%2C%22custom_thickness%22%2C%22special_features%22%2C%22visualiser_enabled%22%5D&restrictSearchableAttributes=%5B%22name%22%2C%22sku%22%2C%22filter_size%22%2C%22filter_material%22%2C%22filter_colour%22%2C%22finish%22%2C%22product_type%22%2C%22floor_or_wall%22%2C%22size%22%5D"

    //var term_searched = jQuery('#tile-search_input').val();
    var term_searched = "";

    if (query_term == term_searched || term_searched.length == 0) {
        jQuery("#products").html("");

        // for (var h in content.hits) {
        //
        //     // VIT MOD: 13-Oct-2016
        //     // Ignore tiles that have not been processed so cannot appear in the visualizer.
        //     //if (!visualizer.tileExists(content.hits[h].sku))
        //     //	continue;
        //     //if(content.hits[h].samples_allowed=='Cut'||content.hits[h].samples_allowed=='Full')
        //     //console.log(content.hits[h].sku+", name: "+content.hits[h].name+" "+content.hits[h].samples_allowed);
        //
        //     var button = "";
        //
        //     if (content.hits[h].samples_allowed == 'Both' || content.hits[h].samples_allowed == 'Cut') {
        //         if (jQuery.inArray(content.hits[h].sku, cartitems) != -1) {
        //
        //             button = '<div class="sample_btns"><button id="' + content.hits[h].sku +
        //                 '" class="item_added_cart"><span><span>Added To Basket</span></span></button><button style="display:none" onclick="addCutSampleToCart(this)" data-sku="' +
        //                 content.hits[h].sku +
        //                 '" class="cut_sample_btn sample-buy-button new_cart_button_free"><span><span class="cut-sample-free">FREE Cut Sample</span><span style="display:none" class="cut-sample-price" >Order cut sample for"' +
        //                 content.hits[h].cs_sample_price + '"</span></span></button></div>';
        //         } else {
        //             button = '<div class="sample_btns"><button onclick="" data-sku="' + content.hits[h].sku +
        //                 '" class="cut_sample_btn sample-buy-button new_cart_button_free"><span><span class="cut-sample-free">FREE Cut Sample</span><span style="display:none" class="cut-sample-price">Order cut sample for"' +
        //                  + '"</span></span></button></div>';
        //         }
        //     };
        //
        //     var html =
        //         '<div  class="col-xs-2"><div  class="v-tile-thumbnail-container "><div style="cursor: pointer;" class="v-actiond sb-v-actiond" data-v-action="SelectTileSKU=' +
        //         content.hits[h].sku +
        //         '"><img class="v-thumbnail v-tile-thumbnail zzimg-responsive" src="thumbnails/tiles/' +
        //         content.hits[h].sku +
        //         '.jpg?"></div><div class="vs-p-name"><p class="v-tile-thumbnail-text"><span><div>' + content.hits[h].name + '</div><div> ' +  content.hits[h].size + 'mm' + ' </div><div> ' + content.hits[h].cs_type + ' <div><div> ' + content.hits[h].brand + ' <div></div></span></p></div></div></div>';
        //
        //     jQuery("#products").append(html);
        //
        // }
    } //if query matches
    if (cartitems.length >= 3) {
        // for (var h in content.hits) {
        //     updateSampleButton();
        // }
    }


    // VIT MOD: 13-Oct-2016
    // Select the tile.
    $(".v-tiles-popup .v-actiond").click(function () {
        visualizer.action($(this).data("v-action"));
    });

    //console.log( " CONTENT RETURNED FROM ALGOLIA "+ JSON.stringify(content.facets['cs_type']));
    if (domint) {
        //jQuery("#filters").html("");
        //for (var fh in content.facets) {

        //    var title = getfacetHeading(fh);
        //    if (!title) {
        //        continue;
        //    }
        //    var facethtml = "<div class='facetparent' data-facet=" + fh + " ><div class='dropdown-heading'><h3>" + title +
        //        "</h3></div>" + "<div class='facetparent-body' data-title=" + fh + ">";
        //    for (var subfilter in content.facets[fh]) {

        //        if (jQuery.inArray(subfilter, checkedvalues) >= 0) {
        //            var checked = "checked";
        //        } else {
        //            var checked = "";
        //        }
        //        facethtml = facethtml + "<div class='facet_filter' data-name=" + subfilter + "><label>" + subfilter +
        //            "</label><div class='span-input'><span>(" + content.facets[fh][subfilter] + ")</span><input data-zero='" +
        //            content.facets[fh][subfilter] + "' " + checked + " data-name='" + subfilter +
        //            "' class='facetcheckbox' data-facet='" + fh + "' type='checkbox' value='" + subfilter +
        //            "' /><div class='filter_checkbox'></div></div></div>";
        //    }
        //    facethtml = facethtml + "</div></div>";
        //    jQuery("#filters").append(facethtml);

        //}
    } else {
        //console.log(" QUERY SEARCHED: "+content.query +" text field "+jQuery("#tile-search_input").val());

        if (query_term == jQuery("#tile-search_input").val()) {
            //alert(facetfilter);
            jQuery(".facetcheckbox").each(function () {
                if (jQuery(this).data("facet") != facetfilter) {
                    jQuery(this).prev("span").text("(0)");
                    jQuery(this).data("zero", 0);
                }
            });

            // if (Object.keys(content.facets).length == 0) { // if no results found
            //     //console.log(" FACETS are empty");
            //     jQuery("input[data-facet]").prev("span").text("(0)");
            //     jQuery("input[data-facet]").data("zero", 0);
            // }
            // for (var fh in content.facets) {
            //     if (fh == 'cs_type') {
            //         //console.log(" cs type length: " + Object.keys(content.facets[fh]).length);
            //         jQuery("input[data-facet='" + fh + "']").prev("span").text("(0)");
            //         jQuery("input[data-facet='" + fh + "']").data("zero", 0);
            //     }
            //     for (var subfilter in content.facets[fh]) {
            //         //if(fh=='cs_type')
            //         //console.log( fh+": "+subfilter+" "+content.facets[fh][subfilter]);
            //         jQuery("input[data-name='" + subfilter + "']").prev("span").text("(" + content.facets[fh][
            //             subfilter
            //         ] + ")");
            //     }
            //
            // }
            jQuery("input[data-zero='0']").remove();

        } //if query matches

    }
    facetFixes();
    jQuery('.span-input').each(function () {
        if (jQuery(this).find('span').text() == '(0)') {
            jQuery(this).parent().hide();
        } else {
            jQuery(this).parent().show();
        }
    })



}

function getfacetHeading(title) {
    if (title == "visualiser_enabled") {
        return 0;
    }
    var headingArray = {
        cs_type: "Type",
        filter_colour: "Colour",
        finish: "Finish",
        filter_material: "Material",
        filter_size: "Size",
        custom_thickness: "Thickness",
        special_features: "Special features"
    };

    return headingArray[title];
}

/** Mini Cart **/

function addCutSampleToCart(e) {
    jQuery('.loader-overlay').show();
    jQuery('.loader').show();
    sku = jQuery(e).data('sku');

    jQuery.ajax({
        type: 'POST',
        url: '/visualizer/shoppingcart/add',
        data: {
            producr_id: sku
        },
        dataType: 'json',
        success: function (data) {

            if (data.success) {
                getCartItems(0);
                jQuery(e).hide().addClass('item_added_cart');
                jQuery(e).parent().append('<button id="' + sku +
                    '" class="item_added_cart"><span><span>Added To Basket</span></span></button>'
                );
                jQuery('.loader-overlay').hide();
                jQuery('.loader').hide();
            }
        }
    });
}

function getCartItems(ondocload) {
    cartitems = [];
    jQuery.ajax({
        type: 'GET',
        url: '/visualiser/shoppingcart/view.json',
        dataType: 'json',
        success: function (data) {

            if (data.success.items) {
                for (i = 0; i < data.success.items.length; i++) {
                    var flag = false;
                    for (x = 0; x < data.success.items[i].options.length; x++) {
                        if (data.success.items[i].options[x].value == "Cut Size") {
                            flag = true;
                        }
                    }
                    if (flag) {
                        cartitems.push(data.success.items[i].sku);
                    }

                }
                updateCartItems(true, data.success.items, data.success.checkout_url, data.success.total);
            } else {
                updateCartItems(false);
            }

            if (ondocload) {

                var __sku = getUrlParameter('sku');
                if (__sku != "" && __sku !== undefined) {
                    visualizer.action("SelectTileSKU=" + __sku);
                    //console.log('yes-cart');
                    //console.log(__sku);
                }
            }

        }
    });
}

function updateCartItems(items, data, url, total) {

    if (items) {
        data.reverse();
        var content = "<h4 class='block-subtitle'>Recently added item(s)</h4><table>";
        for (i = 0; i < data.length; i++) {
            if (i <= 2) {
                content += "<tr><td class='cartpro_img_div'><img class='cart_pro_image' src='" + data[i].image +
                    "' /></td><td><div class='cart-item-name'>" + data[i].name +
                    "</div><div class='qty_and_price'>" + data[i].qty +
                    " x " + data[i].price +
                    "</div></td><td><button class='remove_btn' onClick='deletCartItem(this)' data-sku=" +
                    data[i].sku + " data-item_id='" + data[i].item_id + "'></button></td></tr>";
            }
        }
        content +=
            "</table><span class='cart_subtotal'><h4 class='block-subtitle'>Cart Subtotal : <span class='price'>" +
            total + "</span></h4></span><div class='actions'><a class='proceed_checkout' href='" + url +
            "'>Proceed to Checkout</a></div>";
        jQuery('#cart-Bubble-count').html(data.length);
        jQuery('#cart-Bubble-count').css("display", "block");
        jQuery('#cart-Items').html(content);
    } else {
        jQuery('#cart-Bubble-count').html("");
        jQuery('#cart-Bubble-count').css("display", "none");
        jQuery('#cart-Items').html('You have no items in your shopping cart.');

    }
    updateSampleButton();

}

function deletCartItem(e) {

    jQuery('.loader-overlay').show();
    jQuery('.loader').show();
    var item_id = jQuery(e).data('item_id');
    var sku = jQuery(e).data('sku');

    jQuery.ajax({
        type: 'POST',
        url: '/visualizer/shoppingcart/delete',
        data: {
            item_id: item_id
        },
        dataType: 'json',
        success: function (data) {
            if (data.success) {
                getCartItems(0);

                if (cartitems.length < 3) {
                    //jQuery("#"+sku+"").text("FREE Cut Sample").addClass('cut_sample_btn').attr('onclick','addCutSampleToCart(this)');
                    jQuery("#" + sku + "").hide();
                    jQuery("#" + sku + "").parent().find('.cut_sample_btn').show();
                    jQuery("#" + sku + "").parent().find('.cut-sample-free').show();
                    jQuery("#" + sku + "").parent().find('.cut-sample-price').hide();
                    jQuery("#" + sku + "").remove();
                } else {
                    //jQuery("#"+sku+"").html("Order cut sample for &#163;0.99").addClass('cut_sample_btn').attr('onclick','addCutSampleToCart(this)');
                    jQuery("#" + sku + "").hide();
                    jQuery("#" + sku + "").parent().find('.cut-sample-free').hide();
                    jQuery("#" + sku + "").parent().find('.cut-sample-price').show();
                    jQuery("#" + sku + "").remove();
                }
                jQuery('.loader-overlay').hide();
                jQuery('.loader').hide();
                updateSampleButton();

            }
        }
    });
}

function updateSampleButton() {
    jQuery(".sample_btns").each(function () {
        if (cartitems.length >= 3) {
            jQuery(this).find('.cut-sample-price').show();
            jQuery(this).find('.cut-sample-free').hide();
        } else {
            jQuery(this).find('.cut-sample-price').hide();
            jQuery(this).find('.cut-sample-free').show();
        }
    });
}

function basket_hoverover() {
    jQuery("#cart-Items").css("display", "block");
}

function basket_hoverout() {
    jQuery("#cart-Items").css("display", "none");
}
/** Mini Cart End **/


jQuery(document).on('click', '.facet_filter', function () {
    startSearchbyfacet(jQuery(this).find('input'));
    jQuery(this).find('input').trigger('click');

    jQuery('.loader-overlay').show();
    jQuery('.loader').show();

    setTimeout(function () {
        jQuery('.loader-overlay').hide();
        jQuery('.loader').hide();
    }, 2000);

})
jQuery(document).on('click', '.filter_selected', function () {
    jQuery(this).removeClass('filter_selected');
})


function facetFixes() {

    var thickness = ['2-4', '4-6', '6-8', '8-10', '10-12', 'other'];
    var sizes = ['S', 'M', 'L', 'XL', 'XXL'];

    jQuery('.facetparent-body').each(function () {
        var facetContainer = jQuery(this);
        var facetContained = jQuery(this).find('.facet_filter');
        alphabeticalSort(facetContained, facetContainer, 'data-name');
    });
    /*
     * All Filters Sort
     */
    var facetsContainer = jQuery('#filters');
    var facetsItems = jQuery('.facetparent');
    sorter(facetsContainer, facetsItems, 'data-facet', facets);


    /*
     * Size Sort
     */

    var sizeContainer = jQuery('div[data-title="filter_size"]');
    sizeItems = jQuery('div[data-title="filter_size"]').find(".facet_filter");
    sorter(sizeContainer, sizeItems, 'data-name', sizes);


    /*
     * Thikness Sort
     */

    var thiknessContainer = jQuery('div[data-title="custom_thickness"]');
    var thiknessitems = jQuery('div[data-title="custom_thickness"]').find(".facet_filter");
    sorter(thiknessContainer, thiknessitems, 'data-name', thickness);
    /*Sorting End*/

    jQuery('div[data-name="Beige/Cream/Ivory"] > label').text('Beige/Cream');


}


function sorter(container, contain, dataType, array) {

    contain.sort(function (a, b) {
        var indexA = jQuery.inArray(a.getAttribute(dataType), array);
        var indexB = jQuery.inArray(b.getAttribute(dataType), array);
        return (indexA < indexB) ? -1 : (indexA > indexB) ? 1 : 0;
    });
    contain.detach().appendTo(container);
}

function alphabeticalSort(contain, container, dataType) {

    contain.sort(function (a, b) {
        if (a.getAttribute(dataType) > b.getAttribute(dataType)) {
            return 1;
        }
        if (a.getAttribute(dataType) < b.getAttribute(dataType)) {
            return -1;
        }
        return 0;
    });
    contain.detach().appendTo(container);

}


/*jQuery('.v-tiles-popup-tabs-inject li').click(function(){
    alert('ddd')
})
jQuery('.v-main-fixed-area').click(function(){
    jQuery('.v-tiles-popup-close-icon').trigger('click');
}) */